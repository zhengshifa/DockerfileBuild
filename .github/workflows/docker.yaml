name: Build and Push Docker Image

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
  ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
  ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      ALIYUN_REGISTRY_USER: 804410011@qq.com
      ALIYUN_REGISTRY_PASSWORD: tg6jvi@aly
      ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
      ALIYUN_NAME_SPACE: zhengshifa

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to Alibaba Cloud Docker Registry
      run: |
        docker login -u ${{ env.ALIYUN_REGISTRY_USER }} -p ${{ env.ALIYUN_REGISTRY_PASSWORD }} ${{ env.ALIYUN_REGISTRY }}

        new_image=${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAME_SPACE }}/my-app:latest
        docker build -t  $new_image .
        docker push $new_image
